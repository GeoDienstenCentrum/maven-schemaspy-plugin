language: java

sudo: required

addons:
  postgresql: 9.6
  apt:
    packages:
    - graphviz

services:
  - mysql

env:
  global:
  - BASEURL=https://archive.apache.org/dist/maven/maven-3/VERSION/binaries/apache-maven-VERSION-bin.zip
  - FILE=apache-maven-VERSION-bin.zip
  - DIR=apache-maven-VERSION
  - VERSION=3.5.4

os:
- linux

jdk:
- oraclejdk8
- oraclejdk9
- oraclejdk10
- oraclejdk11
- oraclejdk-ea
- openjdk8

matrix:
  fast_finish: true
  include:
  # additional builds
  - os: linux
    jdk: oraclejdk8
    env: VERSION=3.3.9
  - os: linux
    jdk: oraclejdk8
    env: VERSION=3.5.0
  - os: linux
    jdk: oraclejdk8
    env: VERSION=3.5.2
  - os: linux
    jdk: oraclejdk8
    env: VERSION=3.5.3
  #- os: osx
  #  osx_image: xcode10
  #  env: JVM=latest
  #- os: osx
  #  osx_image: xcode9.3
  #- os: osx
  #  osx_image: xcode9.4
  allow_failures:
  - jdk: oraclejdk-ea

before_install:
   - if [ "$TRAVIS_OS_NAME" == "linux" ]; then
         wget --no-check-certificate $(echo -n $BASEURL | sed -e 's#VERSION#'$VERSION'#g');
         unzip -qq $(echo -n $FILE | sed -e 's#VERSION#'$VERSION'#');
         export M2_HOME=$PWD/$(echo -n $DIR | sed -e 's#VERSION#'$VERSION'#');
         export PATH=$M2_HOME/bin:$PATH;
     fi
   - echo $VERSION
   - echo $M2_HOME
#   - sudo java -XshowSettings:vm -showversion -Xshare:dump

install:
  - mvn install -Dmaven.test.skip=true -B -V -fae -q

before_script:
  - psql -c 'create database test;' -U postgres
  - psql -U postgres -d test -f ./src/test/resources/sql/pgsql.sql
  - mysql -e 'CREATE DATABASE IF NOT EXISTS test;'
  - mysql test < ./src/test/resources/sql/mysql.sql

script:
  - mvn clean test -Dorg.slf4j.simpleLogger.showDateTime=true -Ptravis
  - if [ "$TRAVIS_JDK_VERSION" == "oraclejdk8" ] && [ "$VERSION" == "3.5.4" ]; then
      mvn javadoc:javadoc;
    fi
  - if [ "$TRAVIS_JDK_VERSION" == "oraclejdk8" ] && [ "$VERSION" == "3.5.4" ]; then
      mvn javadoc:test-javadoc;
    fi

cache:
  directories:
  - $HOME/.m2
